<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 plus MathML 2.0//EN" "http://www.w3.org/Math/DTD/mathml2/xhtml-math11-f.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><!--This file was converted to xhtml by LibreOffice - see http://cgit.freedesktop.org/libreoffice/core/tree/filter/source/xslt for the code.--><head profile="http://dublincore.org/documents/dcmi-terms/"><meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8"/><title xml:lang="en-US">- no title specified</title><meta name="DCTERMS.title" content="" xml:lang="en-US"/><meta name="DCTERMS.language" content="en-US" scheme="DCTERMS.RFC4646"/><meta name="DCTERMS.source" content="http://xml.openoffice.org/odf2xhtml"/><meta name="DCTERMS.issued" content="2020-09-14T13:19:20.542939848" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.modified" content="2020-09-15T18:44:31.288278022" scheme="DCTERMS.W3CDTF"/><meta name="DCTERMS.provenance" content="" xml:lang="en-US"/><meta name="DCTERMS.subject" content="," xml:lang="en-US"/><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" hreflang="en"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" hreflang="en"/><link rel="schema.DCTYPE" href="http://purl.org/dc/dcmitype/" hreflang="en"/><link rel="schema.DCAM" href="http://purl.org/dc/dcam/" hreflang="en"/><style type="text/css">
    @page {  }
    table { border-collapse:collapse; border-spacing:0; empty-cells:show }
    td, th { vertical-align:top; font-size:12pt;}
    h1, h2, h3, h4, h5, h6 { clear:both;}
    ol, ul { margin:0; padding:0;}
    li { list-style: none; margin:0; padding:0;}
    /* "li span.odfLiEnd" - IE 7 issue*/
    li span. { clear: both; line-height:0; width:0; height:0; margin:0; padding:0; }
    span.footnodeNumber { padding-right:1em; }
    span.annotation_style_by_filter { font-size:95%; font-family:Arial; background-color:#fff000;  margin:0; border:0; padding:0;  }
    span.heading_numbering { margin-right: 0.8rem; }* { margin:0;}
    .P1 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P10 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P11 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P12 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P13 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P14 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; text-align:center ! important; }
    .P15 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P16 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P17 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; text-align:center ! important; text-decoration:underline; }
    .P18 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P19 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; background-color:transparent; }
    .P2 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; text-align:center ! important; }
    .P20 { font-size:11.25pt; margin-bottom:0cm; margin-top:0cm; font-family:monospace; writing-mode:page; color:#080e31; letter-spacing:normal; font-style:normal; font-weight:normal; }
    .P21 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; margin-left:0cm; margin-right:0cm; text-indent:0cm; }
    .P22 { font-size:11.25pt; margin-bottom:0cm; margin-top:0cm; font-family:monospace; writing-mode:page; color:#080e31; letter-spacing:normal; font-style:normal; font-weight:normal; }
    .P3 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P4 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P5 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P6 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P7 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P8 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .P9 { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .Table_20_Contents { font-size:12pt; font-family:Liberation Serif; writing-mode:page; }
    .Tableau1 { width:17cm; float:none; }
    .Tableau2 { width:17cm; float:none; }
    .Tableau3 { width:17cm; float:none; }
    .Tableau1_A1 { padding:0.097cm; border-width:thin; border-style:solid; border-color:#000000; }
    .Tableau2_A1 { padding:0.097cm; border-width:thin; border-style:solid; border-color:#000000; }
    .Tableau3_A1 { padding:0.097cm; border-width:thin; border-style:solid; border-color:#000000; }
    .Tableau1_A { width:17cm; }
    .Tableau2_A { width:17cm; }
    .Tableau3_A { width:17cm; }
    .Internet_20_link { color:#000080; text-decoration:underline; }
    .T2 { font-style:italic; }
    .T3 { font-style:normal; }
    .T4 { color:#333333; font-family:Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace; font-size:11.25pt; letter-spacing:normal; font-style:normal; font-weight:normal; }
    .T5 { color:#333333; font-family:Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace; font-size:11.25pt; letter-spacing:normal; font-style:normal; font-weight:bold; }
    .T8 { background-color:#ffff00; }
    .T9 { background-color:#ffff00; }
    /* ODF styles with no properties representable as CSS */
    .T1 .T6 .T7  { }
    </style></head><body dir="ltr" style="max-width:21.001cm;margin-top:2cm; margin-bottom:2cm; margin-left:2cm; margin-right:2cm; "><p class="P2">Certificat de securité : </p><p class="P17">certbot</p><p class="P4">install software-properties-common</p><p class="P5">add-apt-repository ppa:certbot/certbot</p><p class="P5">install certbot</p><p class="P5"> </p><p class="P16">Soit ne pas avoir de server du le port 443 (et 80 pour le renew), soit utiliser le bon plugin (ici nginx, installer le plugin certbot nginx, et –nginx dans les lignes de commande)</p><p class="P7">certbot certonly</p><p class="P7">1 – temporary standalone server</p><p class="P7">=&gt; mettre uniquement le fqdn de openfire (il a l’air de pas aimer sinon)</p><p class="P1"> </p><p class="P2">serveur XMPP :</p><p class="P17">openfire</p><p class="P6">télécharger sur le site le fichier deb https://www.igniterealtime.org/downloads/</p><p class="P6">installer une jre</p><p class="P6">dpkg -i le_paquet</p><p class="P6">=&gt; 127.0.0.1:9090 console d’admin pour paramétrer le truc</p><p class="P7">nom du server et fqdn identiques (sinon niveau certificats a première vue ca chie)</p><p class="P6"> </p><p class="P6">paramètres du server / http bindings / script syntax =&gt; enabled (BOSH)</p><p class="P6"> </p><p class="P10">ne pas oublier les enregistrements DNS (gestion du server, paramètres du server, clique sur le message DNS)</p><p class="P7">et</p><p class="P7">server=&gt;tls/ssl certificates=&gt;identity store=&gt;manage store content=&gt;lui donner le contenu de privkey.pem et cert.pem sans mot de passe</p><p class="P7"> </p><p class="P18">Script bash pour installer les certificats dans openfire <span class="T7">(</span><span class="T8">le but est de l’installer dans le post hook des opérations de renew du certbot, je sais pas encore faire</span><span class="T7">)</span>:</p><p class="P18"> </p><table border="0" cellspacing="0" cellpadding="0" class="Tableau1"><colgroup><col width="743"/></colgroup><tr><td style="text-align:left;width:17cm; " class="Tableau1_A1"><p class="Table_20_Contents">#!/bin/bash</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">export PASS=changeit <span class="T6"># mot de passe par defaut de openfire (</span><span class="T9">pour l’instant je sais pas le changer</span><span class="T6">)</span></p><p class="Table_20_Contents">P12=$( mktemp -q /tmp/server.XXXXXX )</p><p class="Table_20_Contents">ALIAS=msg.warin.info</p><p class="Table_20_Contents">KNEW=/etc/openfire/security/keystore.new</p><p class="Table_20_Contents">KOLD=/etc/openfire/security/keystore</p><p class="Table_20_Contents">FULL=/etc/letsencrypt/live/msg.warin.info/fullchain.pem</p><p class="Table_20_Contents">PRIV=/etc/letsencrypt/live/msg.warin.info/privkey.pem</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">rm -f $KNEW</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">openssl pkcs12 -export -password env:PASS -in $FULL -inkey $PRIV -out $P12 -name $ALIAS</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">keytool -importkeystore -deststorepass $PASS -destkeypass $PASS -destkeystore $KNEW -deststoretype PKCS12 -srckeystore $P12 -srcstoretype PKCS12 -srcstorepass $PASS -alias $ALIAS</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">rm -f $P12</p><p class="Table_20_Contents"> </p><p class="Table_20_Contents">mv $KOLD $KOLD.$( date "+%s" )</p><p class="Table_20_Contents">mv $KNEW $KOLD</p><p class="P21"><span class="T4">service openfire </span><span class="T5">stop</span></p><p class="P21"><span class="T4">service openfire </span><span class="T5">start</span></p></td></tr></table><p class="P19"> </p><p class="P18"> </p><p class="P3"> </p><p class="P3"> </p><p class="P2">Client XMPP :</p><p class="P17">conversejs <span class="T1">via nginx</span></p><p class="P1"><a href="https://github.com/conversejs/converse.js/releases" class="Internet_20_link">https://github.com/conversejs/converse.js/releases</a></p><p class="P1"> </p><p class="P13">mis dans /<span class="T2">var/</span><span class="T3">www/converseje</span></p><p class="P8">fichier index de converse :</p><p class="P8"> </p><table border="0" cellspacing="0" cellpadding="0" class="Tableau2"><colgroup><col width="743"/></colgroup><tr><td style="text-align:left;width:17cm; " class="Tableau2_A1"><p class="P9">&lt;html&gt;</p><p class="P9"><span> &lt;head&gt;</span></p><p class="P9"><span> </span><span> &lt;link rel="stylesheet" type="text/css" media="screen" href="https://cdn.conversejs.org/6.0.0/dist/converse.min.css"&gt;</span></p><p class="P9"><span> </span><span> &lt;script src="https://cdn.conversejs.org/6.0.0/dist/converse.min.js" charset="utf-8"&gt;&lt;/script&gt;</span></p><p class="P9"><span> &lt;/head&gt;</span></p><p class="P9"><span> &lt;body&gt;</span></p><p class="P9"><span> </span><span> &lt;script&gt;</span></p><p class="P9">    converse.initialize({</p><p class="P9">        bosh_service_url: 'https://msg.warin.info:7443/http-bind/', // Please use this connection manager only for testing purposes</p><p class="P9"><span>     authentication: 'login',</span></p><p class="P9"><span> view_mode: 'fullscreen',</span></p><p class="P9"><span>     default_domain: 'https://msg.warin.info:7443/http-bind/',</span></p><p class="P9"><span>     registration_domain: 'https://msg.warin.info:7443/http-bind/'</span></p><p class="P9">    });</p><p class="P9">&lt;/script&gt;</p><p class="P9"><span> &lt;/body&gt;</span></p><p class="P9">&lt;/html&gt;</p></td></tr></table><p class="P8"> </p><p class="P1"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"> </p><p class="P14"/><p class="P14"> </p><p class="P14"> </p><p class="P14">Server Nginx</p><p class="P7">config nginx :</p><p class="P7"> </p><table border="0" cellspacing="0" cellpadding="0" class="Tableau3"><colgroup><col width="743"/></colgroup><tr><td style="text-align:left;width:17cm; " class="Tableau3_A1"><p class="P9">server {</p><p class="P9">    listen 443 ssl http2;</p><p class="P9">    listen [::]:4443 ssl http2;</p><p class="P9">    server_name msg.warin.info;</p><p class="P9"> </p><p class="P9">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</p><p class="P9">    ssl_prefer_server_ciphers on;</p><p class="P9">    ssl_ciphers "EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA256:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EDH+aRSA+AESGCM:EDH+aRSA+SHA256:EDH+aRSA:EECDH:!aNULL:!eNULL:!MEDIUM:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!RC4:!SEED";</p><p class="P9"> </p><p class="P9">    add_header Strict-Transport-Security "max-age=31536000";</p><p class="P9"> </p><p class="P9">    ssl_certificate /etc/letsencrypt/live/msg.warin.info/cert.pem;</p><p class="P9">    ssl_certificate_key /etc/letsencrypt/live/msg.warin.info/privkey.pem;</p><p class="P9"> </p><p class="P9">    root /var/www/conversejs;</p><p class="P9"> </p><p class="P9">    gzip on;</p><p class="P9">    gzip_types text/plain text/css application/javascript application/json;</p><p class="P9">    gzip_vary on;</p><p class="P9"> </p><p class="P9">}</p></td></tr></table><p class="P7"> </p><p class="P7"> </p><p class="P11">Ports utilisés et donc natés sur le routeur :</p><p class="P11"> </p><p class="P11">443 pour converse</p><p class="P11">7443 pour openfire &lt;=&gt; converse</p><p class="P12">5222 pour openfire &lt;=&gt; client xmpp classique</p><p class="P12"> </p><p class="P12"> </p><p class="P15">Ajouté dans le DNS :</p><p class="P15"> </p><p class="P22">msg 1800 IN A 82.65.97.114</p><p class="P22">msg 900 IN SRV 0 5 5222 _xmpp-client._tcp.msg.warin.info.</p><p class="P20">msg 900 IN SRV 0 5 5223 _xmpps-client._tcp.msg.warin.info.</p><p class="P20">msg 900 IN SRV 0 5 5269 _xmpp-server._tcp.msg.warin.info.</p><p class="P20">msg 900 IN SRV 0 5 5270 _xmpps-server._tcp.msg.warin.info.</p><p class="P15"> </p></body></html>